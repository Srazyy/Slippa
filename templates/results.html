{% extends "base.html" %}
{% block title %}Results ‚Äî Slippa{% endblock %}

{% block content %}
{% if job.status == 'done' and job.clips %}
<div class="results-header">
    <h2>{{ job.clips | length }} Clips from "{{ job.video_title }}"</h2>
    <div style="display: flex; gap: 10px;">
        <button class="btn-secondary" id="yt-auth-btn" style="display: none;">üîë Connect YouTube</button>
        <a href="/" class="btn-secondary">+ New Video</a>
    </div>
</div>

<div class="clips-grid">
    {% for clip in job.clips %}
    <div class="clip-card" id="clip-card-{{ loop.index }}">
        <div class="clip-preview">
            <video controls preload="metadata">
                <source src="/clips/{{ job_id }}/{{ clip.filename }}" type="video/mp4">
            </video>
        </div>
        <div class="clip-info">
            <div class="clip-header">
                <h3>Clip {{ clip.index }}</h3>
                <div style="display: flex; gap: 6px; align-items: center;">
                    {% if clip.label and clip.label != '‚Äî' %}
                    <span
                        class="clip-label clip-label-{{ clip.label.split(' ')[1] | lower if clip.label.split(' ') | length > 1 else 'meh' }}">
                        {{ clip.label }}
                    </span>
                    {% endif %}
                    <span class="clip-badge">{{ clip.duration }}s</span>
                </div>
            </div>
            <p class="clip-time">{{ clip.start }}s ‚Üí {{ clip.end }}s</p>
            <p class="clip-transcript">{{ clip.text }}</p>

            <!-- Smart score breakdown -->
            {% if clip.score_breakdown %}
            <div class="score-breakdown">
                <div class="score-bar-row">
                    <span class="score-label">Score</span>
                    <div class="score-bar-track">
                        <div class="score-bar-fill" style="width: {{ (clip.score / 10 * 100) | round }}%"></div>
                    </div>
                    <span class="score-value">{{ clip.score }}/10</span>
                </div>
                {% if clip.score_breakdown.engagement is defined %}
                <div class="score-details" style="display: none;" id="details-{{ loop.index }}">
                    <div class="score-bar-row mini">
                        <span class="score-label">üéØ Engage</span>
                        <div class="score-bar-track mini">
                            <div class="score-bar-fill engage"
                                style="width: {{ (clip.score_breakdown.engagement / 10 * 100) | round }}%"></div>
                        </div>
                        <span class="score-value">{{ clip.score_breakdown.engagement }}</span>
                    </div>
                    <div class="score-bar-row mini">
                        <span class="score-label">üíñ Emotion</span>
                        <div class="score-bar-track mini">
                            <div class="score-bar-fill emotion"
                                style="width: {{ (clip.score_breakdown.emotion / 10 * 100) | round }}%"></div>
                        </div>
                        <span class="score-value">{{ clip.score_breakdown.emotion }}</span>
                    </div>
                    <div class="score-bar-row mini">
                        <span class="score-label">üß© Coherence</span>
                        <div class="score-bar-track mini">
                            <div class="score-bar-fill coherence"
                                style="width: {{ (clip.score_breakdown.coherence / 10 * 100) | round }}%"></div>
                        </div>
                        <span class="score-value">{{ clip.score_breakdown.coherence }}</span>
                    </div>
                    <div class="score-bar-row mini">
                        <span class="score-label">üöÄ Viral</span>
                        <div class="score-bar-track mini">
                            <div class="score-bar-fill viral"
                                style="width: {{ (clip.score_breakdown.virality / 10 * 100) | round }}%"></div>
                        </div>
                        <span class="score-value">{{ clip.score_breakdown.virality }}</span>
                    </div>
                </div>
                <button class="btn-details" onclick="toggleDetails({{ loop.index }})">‚ñ∏ Details</button>
                {% endif %}
            </div>
            {% else %}
            <div class="clip-meta">
                <span class="clip-score">Score: {{ clip.score }}</span>
                <span class="clip-size">{{ clip.size_kb }} KB</span>
            </div>
            {% endif %}

            <div class="clip-actions">
                <a href="/download/{{ job_id }}/{{ clip.filename }}" class="btn-download">‚¨á Download</a>
                <button class="btn-upload"
                    onclick="uploadClip(this, '{{ job_id }}', '{{ clip.filename }}', 'Clip {{ clip.index }} - {{ job.video_title }}')">
                    üì§ YouTube
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<style>
    .clip-label {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .clip-label-viral {
        background: linear-gradient(135deg, #ff4500, #ff6b35);
        color: #fff;
    }

    .clip-label-great {
        background: linear-gradient(135deg, #f59e0b, #eab308);
        color: #1a1a2e;
    }

    .clip-label-good {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: #fff;
    }

    .clip-label-meh {
        background: rgba(255, 255, 255, 0.08);
        color: #888;
    }

    .score-breakdown {
        margin: 10px 0 8px;
    }

    .score-bar-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .score-bar-row.mini {
        margin-bottom: 3px;
    }

    .score-label {
        font-size: 0.72rem;
        color: #aaa;
        min-width: 70px;
        text-align: right;
    }

    .score-bar-track {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 4px;
        overflow: hidden;
    }

    .score-bar-track.mini {
        height: 5px;
    }

    .score-bar-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        transition: width 0.6s ease;
    }

    .score-bar-fill.engage {
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }

    .score-bar-fill.emotion {
        background: linear-gradient(90deg, #ec4899, #f472b6);
    }

    .score-bar-fill.coherence {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .score-bar-fill.viral {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .score-value {
        font-size: 0.72rem;
        color: #ccc;
        min-width: 32px;
        font-variant-numeric: tabular-nums;
    }

    .score-details {
        margin-top: 6px;
        padding: 8px 0 2px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .btn-details {
        background: none;
        border: none;
        color: #8b5cf6;
        font-size: 0.72rem;
        cursor: pointer;
        padding: 2px 0;
        margin-top: 2px;
    }

    .btn-details:hover {
        color: #a78bfa;
    }
</style>

{% elif job.status == 'error' %}
<div class="card">
    <h2>Something went wrong</h2>
    <p class="status-text" style="color: var(--error);">{{ job.progress }}</p>
    <a href="/" class="btn-secondary" style="margin-top: 16px; display: inline-block;">Try Again</a>
</div>
{% else %}
<div class="card">
    <h2>Processing...</h2>
    <p class="status-text">{{ job.progress }}</p>
    <script>setTimeout(() => location.reload(), 2000);</script>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function toggleDetails(idx) {
        const el = document.getElementById('details-' + idx);
        const btn = el.previousElementSibling || el.parentElement.querySelector('.btn-details');
        if (el.style.display === 'none') {
            el.style.display = 'block';
            // Find the button that triggered this
            const btns = el.parentElement.querySelectorAll('.btn-details');
            btns.forEach(b => { if (b.textContent.includes('Details')) b.textContent = '‚ñæ Details'; });
        } else {
            el.style.display = 'none';
            const btns = el.parentElement.querySelectorAll('.btn-details');
            btns.forEach(b => b.textContent = '‚ñ∏ Details');
        }
    }

    let ytAuth = false;
    async function checkYouTubeStatus() {
        try {
            const r = await fetch('/youtube/status');
            const d = await r.json();
            if (!d.configured) {
                document.querySelectorAll('.btn-upload').forEach(b => { b.textContent = '‚ö†Ô∏è Setup'; b.disabled = true; b.classList.add('btn-disabled'); });
            } else if (!d.authenticated) {
                const authBtn = document.getElementById('yt-auth-btn');
                if (authBtn) { authBtn.style.display = 'inline-flex'; authBtn.onclick = () => window.location.href = '/youtube/auth'; }
            } else { ytAuth = true; }
        } catch (e) { }
    }

    async function uploadClip(btn, jobId, filename, title) {
        if (!ytAuth) { if (confirm('Connect YouTube first?')) window.location.href = '/youtube/auth'; return; }
        btn.disabled = true; btn.textContent = '‚è≥...'; btn.classList.add('btn-uploading');
        const res = await fetch('/upload', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: jobId, filename, title, description: 'Generated by Slippa', privacy: 'private' })
        });
        const data = await res.json();
        if (data.need_auth) { window.location.href = '/youtube/auth'; return; }
        if (data.error) { btn.textContent = '‚ùå Error'; btn.classList.remove('btn-uploading'); return; }
        const iv = setInterval(async () => {
            const r = await fetch(`/upload-status/${data.upload_id}`);
            const d = await r.json();
            if (d.status === 'done') {
                clearInterval(iv); btn.textContent = '‚úÖ Done'; btn.classList.remove('btn-uploading'); btn.classList.add('btn-uploaded');
                if (d.result?.url) { const a = document.createElement('a'); a.href = d.result.url; a.target = '_blank'; a.className = 'yt-link'; a.textContent = 'üîó View'; btn.parentElement.appendChild(a); }
            } else if (d.status === 'error') { clearInterval(iv); btn.textContent = '‚ùå'; btn.classList.remove('btn-uploading'); }
        }, 2000);
    }

    checkYouTubeStatus();
</script>
{% endblock %}