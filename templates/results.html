{% extends "base.html" %}
{% block title %}Results ‚Äî Slippa{% endblock %}

{% block content %}
{% if job.status == 'done' and job.clips %}
<div class="results-header">
    <h2>{{ job.clips | length }} Clips from "{{ job.video_title }}"</h2>
    <div style="display: flex; gap: 10px;">
        <button class="btn-secondary" id="yt-auth-btn" style="display: none;">üîë Connect YouTube</button>
        <a href="/" class="btn-secondary">+ New Video</a>
    </div>
</div>

<div class="clips-grid">
    {% for clip in job.clips %}
    <div class="clip-card" id="clip-card-{{ loop.index }}">
        <div class="clip-preview">
            <video controls preload="metadata">
                <source src="/clips/{{ job_id }}/{{ clip.filename }}" type="video/mp4">
            </video>
        </div>
        <div class="clip-info">
            <div class="clip-header">
                <h3>Clip {{ clip.index }}</h3>
                <span class="clip-badge">{{ clip.duration }}s</span>
            </div>
            <p class="clip-time">{{ clip.start }}s ‚Üí {{ clip.end }}s</p>
            <p class="clip-transcript">{{ clip.text }}</p>
            <div class="clip-meta">
                <span class="clip-score">Score: {{ clip.score }}</span>
                <span class="clip-size">{{ clip.size_kb }} KB</span>
            </div>
            <div class="clip-actions">
                <a href="/download/{{ job_id }}/{{ clip.filename }}" class="btn-download">‚¨á Download</a>
                <button class="btn-upload"
                    onclick="uploadClip(this, '{{ job_id }}', '{{ clip.filename }}', 'Clip {{ clip.index }} - {{ job.video_title }}')">
                    üì§ YouTube
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% elif job.status == 'error' %}
<div class="card">
    <h2>Something went wrong</h2>
    <p class="status-text" style="color: var(--error);">{{ job.progress }}</p>
    <a href="/" class="btn-secondary" style="margin-top: 16px; display: inline-block;">Try Again</a>
</div>
{% else %}
<div class="card">
    <h2>Processing...</h2>
    <p class="status-text">{{ job.progress }}</p>
    <script>setTimeout(() => location.reload(), 2000);</script>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    let ytAuth = false;
    async function checkYouTubeStatus() {
        try {
            const r = await fetch('/youtube/status');
            const d = await r.json();
            if (!d.configured) {
                document.querySelectorAll('.btn-upload').forEach(b => { b.textContent = '‚ö†Ô∏è Setup'; b.disabled = true; b.classList.add('btn-disabled'); });
            } else if (!d.authenticated) {
                const authBtn = document.getElementById('yt-auth-btn');
                if (authBtn) { authBtn.style.display = 'inline-flex'; authBtn.onclick = () => window.location.href = '/youtube/auth'; }
            } else { ytAuth = true; }
        } catch (e) { }
    }

    async function uploadClip(btn, jobId, filename, title) {
        if (!ytAuth) { if (confirm('Connect YouTube first?')) window.location.href = '/youtube/auth'; return; }
        btn.disabled = true; btn.textContent = '‚è≥...'; btn.classList.add('btn-uploading');
        const res = await fetch('/upload', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: jobId, filename, title, description: 'Generated by Slippa', privacy: 'private' })
        });
        const data = await res.json();
        if (data.need_auth) { window.location.href = '/youtube/auth'; return; }
        if (data.error) { btn.textContent = '‚ùå Error'; btn.classList.remove('btn-uploading'); return; }
        const iv = setInterval(async () => {
            const r = await fetch(`/upload-status/${data.upload_id}`);
            const d = await r.json();
            if (d.status === 'done') {
                clearInterval(iv); btn.textContent = '‚úÖ Done'; btn.classList.remove('btn-uploading'); btn.classList.add('btn-uploaded');
                if (d.result?.url) { const a = document.createElement('a'); a.href = d.result.url; a.target = '_blank'; a.className = 'yt-link'; a.textContent = 'üîó View'; btn.parentElement.appendChild(a); }
            } else if (d.status === 'error') { clearInterval(iv); btn.textContent = '‚ùå'; btn.classList.remove('btn-uploading'); }
        }, 2000);
    }

    checkYouTubeStatus();
</script>
{% endblock %}